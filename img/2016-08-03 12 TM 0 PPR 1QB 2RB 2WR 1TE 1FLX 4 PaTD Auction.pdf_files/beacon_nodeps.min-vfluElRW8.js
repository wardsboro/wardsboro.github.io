(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define([],function(){var e,n,r,s,i,a,o,h,_,u,c,p,l,f,d,w,b,g,m,x,y,v,k,E;return s=5e3,i=12e4,_=6e4,u="invalid_agent",e="authorization_error",c=32,w=64,p=64,d=32,l=128,f=32,a="-",o="|",b={WEB:0,IOS:1,ANDROID:2,DESKTOP:3},y=function(){function t(t,e,n){var r,s,i,a;this.platform=t,this.surface=e,this.identifier=null!=n?n:null,s=!1;for(r in b)if(a=b[r],this.platform===a){s=!0;break}if(!s)throw new Error("platform must be from Beacon.Platforms");if(this.surface.length>d)throw new Error("surface must be <= "+d+" chars.");if((null!=(i=this.identifier)?i.length:void 0)>l)throw new Error("identifier must be <= "+l+" chars.");null===this.identifier&&(this.identifier="")}return t.from_json=function(e){return new t(e.platform,e.surface,e.identifier)},t}(),n=function(){function t(t,e,n,r){if(this.user_id=t,this.app=e,this.context=n,this.source=r,this.user_id.length>w)throw new Error("user_id must be <= "+w+" chars.");if(this.app.length>c)throw new Error("app must be <= "+c+" chars.");if(this.context.length>p)throw new Error("context must be <= "+p+" chars.")}return t.from_json=function(e){var n;return n=y.from_json(e.source),new t(e.user_id,e.app,e.context,n)},t}(),r=function(){function t(t,e,n){if(this.agent=t,this.status=e,this.auth_key=null!=n?n:null,this.status.length>f)throw new Error("status must be <= "+f+" chars")}return t.from_json=function(e){return new t(n.from_json(e.agent),e.status)},t}(),m={UserContext:"UserContext",UserApp:"UserApp",Context:"Context"},g=function(){function t(t,e,n,r,s){var i,a;if(this.type=t,this.user_id=e,this.app=n,this.context=r,this.token=s,this.type!==m.UserContext&&this.type!==m.UserApp&&this.type!==m.Context)throw new Error("Unsupported type: "+this.type+".");if((null!=(i=this.user_id)?i.length:void 0)>w)throw new Error("user_id must be <= "+w+" chars.");if(this.app.length>c)throw new Error("app must be <= "+c+" chars.");if((null!=(a=this.context)?a.length:void 0)>p)throw new Error("context must be <= "+p+" chars.")}return t}(),E=function(){function t(t,e){this.presence_params=t,this.agents=e}return t}(),k=function(){function t(t,e){this.presence_params=t,this.status=e}return t.Status={Offline:1,Online:2},t}(),h=function(){function t(t,e,n){this.presence_params=t,this.snapshot=e,this.delta=n}return t}(),v=function(){function r(e,n,r,s,i,a,o){this._token=e,this._authn_cb=n,this._authz_cb=r,this._beacon_server=s,this._ajax=i,this._u=a,this._exclog=null!=o?o:null,this._handle_heartbeat_error=t(this._handle_heartbeat_error,this),this._handle_heartbeat_success=t(this._handle_heartbeat_success,this),this._heartbeat=t(this._heartbeat,this),this._started=!1,this._heartbeat_xhr=null,this._timeout_id=null,this._presence_data=[],this._offline_agents=[],this._has_changes=!1}return r.prototype.start=function(){return this._started?void 0:(this._backoff_window=s,this._started=!0,this._has_changes=!1,this._heartbeat())},r.prototype.stop=function(){return this._started=!1,this._heartbeat_xhr=null,window.clearTimeout(this._timeout_id),this._timeout_id=null},r.prototype.add_or_update_agents=function(t){var e,n,r;for(n=0,r=t.length;r>n;n++)e=t[n],this._has_changes|=this._add_or_update_agent(e);if(!this._heartbeat_xhr&&this._started)return window.clearTimeout(this._timeout_id),this._timeout_id=window.setTimeout(this._heartbeat,0)},r.prototype.update_token=function(t){this._token=t},r.prototype._add_or_update_agent=function(t){var e,n,r,s,i;for(i=this._presence_data,n=e=0,r=i.length;r>e;n=++e)if(s=i[n],this._u.isEqual(s.agent,t.agent))return s.status!==t.status||s.auth_key!==t.auth_key?(this._presence_data[n]=t,!0):!1;return this._presence_data.push(t),!0},r.prototype._heartbeat=function(){return this._started&&0!==this._presence_data.length?(this._offline_agents=this._presence_data.filter(function(t){return""!==t.status}).map(function(t){return t.agent}),this._has_changes=!1,this._heartbeat_xhr=this._ajax({url:"https://"+this._beacon_server+"/1/update",type:"POST",data:JSON.stringify({token:this._token,updates:this._presence_data}),contentType:"application/json; charset=utf-8",dataType:"json",timeout:5e3,success:this._handle_heartbeat_success,error:this._handle_heartbeat_error,xhrFields:{withCredentials:!0}})):void 0},r.prototype._handle_heartbeat_success=function(t,r,i){var a,o,h,c,p,l,f,d,w,b,g,m,x,y,v,k,E,U;if(this._heartbeat_xhr=null,this._started){for(c=[],v=t.agent_errors||[],f=0,g=v.length;g>f;f++)o=v[f],p=o.error,a=n.from_json(o.agent),p===e?c.push(a):p===u&&null!=(k=this._exclog)&&k.raiseAndReport("Input error: "+o),this._presence_data=this._presence_data.filter(function(t){return function(e){return!t._u.isEqual(e.agent,a)}}(this));for(c.length&&window.setTimeout(function(t){return function(){return t._authz_cb(c)}}(this),0),E=this._offline_agents,w=0,m=E.length;m>w;w++)for(y=E[w],U=this._presence_data,d=b=0,x=U.length;x>b;d=++b)if(h=U[d],this._u.isEqual(h.agent,y)&&""===h.status){this._presence_data.splice(d,1);break}return l=this._has_changes?0:_,this._backoff_window=s,this._timeout_id=window.setTimeout(this._heartbeat,l)}},r.prototype._handle_heartbeat_error=function(t,e,n){var r,s;if(this._heartbeat_xhr=null,this._started){if(t.status>=400&&t.status<500){if(401===t.status)return window.setTimeout(this._authn_cb,0),void this.stop();400===t.status&&null!=(s=this._exclog)&&s.raiseAndReport("Bad request: "+t.responseText)}return r=Math.random()*this._backoff_window,this._backoff_window=Math.min(2*this._backoff_window,i),this._timeout_id=window.setTimeout(this._heartbeat,r)}},r}(),x=function(){function e(e,n,r,s,i,a,o,h){var _,u;this._presence_params=e,this._update_callback=n,this._refresh_callback=r,this._bolt=s,this._u=o,null==h&&(h=null),this._on_refresh=t(this._on_refresh,this),this._on_update=t(this._on_update,this),this._compact_context_updates=t(this._compact_context_updates,this),_=function(){var t,e,n,r;for(n=this._presence_params,r=[],t=0,e=n.length;e>t;t++)u=n[t],r.push(this._presence_params_to_bolt_channel(u));return r}.call(this),this._thunder_client=new this._bolt.ThunderClient(_,this._on_update,this._on_refresh,i,a,this._u,h)}return e.prototype.start=function(){return this._thunder_client.start()},e.prototype.stop=function(){return this._thunder_client.unsubscribe()},e.prototype._presence_params_to_bolt_channel=function(t){switch(t.type){case m.UserContext:return new this._bolt.SignedChannelState("beacon_uc"+a+t.app,""+t.user_id+o+t.context,"0",t.token);case m.UserApp:return new this._bolt.SignedChannelState("beacon_ua"+a+t.app,t.user_id,"0",t.token);case m.Context:return new this._bolt.SignedChannelState("beacon_c"+a+t.app,t.context,"0",t.token);default:throw new Error("Unknown type: "+t.type)}},e.prototype._bolt_channel_to_presence_params=function(t){var e,n,r,s,i,h;if(n=t.app_id.split(a),i=t.unique_id.split(o),2!==n.length)throw new Error("Unexpected format of Bolt app_id: "+t.app_id+".");switch(e=n[1],h="",r="",n[0]){case"beacon_uc":if(2!==i.length)throw new Error("Unexpected format of beacon_uc: "+t.unique_id+".");s=m.UserContext,h=i[0],r=i[1];break;case"beacon_ua":if(1!==i.length)throw new Error("Unexpected format of beacon_ua: "+t.unique_id+".");s=m.UserApp,h=i[0];break;case"beacon_c":if(1!==i.length)throw new Error("Unexpected format of beacon_c: "+t.unique_id+".");s=m.Context,r=i[0];break;default:throw new Error("Unknown Bolt app_id: "+t.app_id+".")}return new g(s,h,e,r,null)},e.prototype._compact_context_updates=function(t,e){var n,r,s,i,a,o,_,u,c,p,l,f,d,w,b,g;for(o=!1,n=[],i=0,c=e.length;c>i;i++)if(g=e[i],null!=g.snapshot)o=!0,n=g.snapshot;else if(null!=g.delta)for(w=g.delta,_=0,p=w.length;p>_;_++){for(f=w[_],s=!1,a=u=0,l=n.length;l>u;a=++u)if(d=n[a],this._u.isEqual(d.agent,f.agent)){s=!0,n[a]=f;break}s||n.push(f)}return o?(b=n,r=null):(b=null,r=n),new h(t,b,r)},e.prototype._on_update=function(t){var e,s,i,a,o,h,_,u,c,p,l,f,d;for(d=[],_=0,c=t.length;c>_;_++)a=t[_],o=a.channel_state,i=new this._bolt.ChannelId(o.app_id,o.unique_id),u=this._bolt_channel_to_presence_params(i),d.push(function(){switch(u.type){case m.UserContext:return l=a.payloads.slice(-1)[0].payload,s=null!=l.agents?function(){var t,n,s,i;for(s=l.agents,i=[],t=0,n=s.length;n>t;t++)e=s[t],i.push(r.from_json(e));return i}():[],new E(u,s);case m.UserApp:return l=a.payloads.slice(-1)[0].payload,new k(u,l.status);case m.Context:return h=function(t){var s;return s=y.from_json(t.source),e=new n(t.user_id,u.app,u.context,s),new r(e,t.status)},p=function(t){var e,n,r;return{snapshot:null!=(null!=(n=t.snapshot)?n.agents:void 0)?function(){var n,r,s,i;for(s=t.snapshot.agents,i=[],n=0,r=s.length;r>n;n++)e=s[n],i.push(h(e));return i}():void 0,delta:null!=(null!=(r=t.delta)?r.agents:void 0)?function(){var n,r,s,i;for(s=t.delta.agents,i=[],n=0,r=s.length;r>n;n++)e=s[n],i.push(h(e));return i}():void 0}},f=function(){var t,e,n,r;for(n=a.payloads,r=[],t=0,e=n.length;e>t;t++)l=n[t],r.push(p(l.payload));return r}(),this._compact_context_updates(u,f)}}.call(this));return this._update_callback(d)},e.prototype._on_refresh=function(t){var e;return this._refresh_callback(function(){var n,r,s;for(s=[],n=0,r=t.length;r>n;n++)e=t[n],s.push(this._bolt_channel_to_presence_params(e));return s}.call(this))},e}(),{Agent:n,AgentStatus:r,Platforms:b,PresenceParams:g,PresenceType:m,Receiver:x,Source:y,Transmitter:v,UserAppPresence:k,UserContextPresence:E}})}).call(this);
//# sourceMappingURL=beacon_nodeps.min.js-vflvPuD51.map